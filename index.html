<!doctype html>
<html>
	<head>
		<title>Collaborative Text Editor</title>
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"  crossorigin="anonymous">
		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>
		<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
		<script type="text/javascript">
			/* mousetrap v1.5.3 craig.is/killing/mice */
			(function(C,r,g){function t(a,b,h){a.addEventListener?a.addEventListener(b,h,!1):a.attachEvent("on"+b,h)}function x(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);a.shiftKey||(b=b.toLowerCase());return b}return l[a.which]?l[a.which]:p[a.which]?p[a.which]:String.fromCharCode(a.which).toLowerCase()}function D(a){var b=[];a.shiftKey&&b.push("shift");a.altKey&&b.push("alt");a.ctrlKey&&b.push("ctrl");a.metaKey&&b.push("meta");return b}function u(a){return"shift"==a||"ctrl"==a||"alt"==a||
			"meta"==a}function y(a,b){var h,c,e,g=[];h=a;"+"===h?h=["+"]:(h=h.replace(/\+{2}/g,"+plus"),h=h.split("+"));for(e=0;e<h.length;++e)c=h[e],z[c]&&(c=z[c]),b&&"keypress"!=b&&A[c]&&(c=A[c],g.push("shift")),u(c)&&g.push(c);h=c;e=b;if(!e){if(!k){k={};for(var m in l)95<m&&112>m||l.hasOwnProperty(m)&&(k[l[m]]=m)}e=k[h]?"keydown":"keypress"}"keypress"==e&&g.length&&(e="keydown");return{key:c,modifiers:g,action:e}}function B(a,b){return null===a||a===r?!1:a===b?!0:B(a.parentNode,b)}function c(a){function b(a){a=
			a||{};var b=!1,n;for(n in q)a[n]?b=!0:q[n]=0;b||(v=!1)}function h(a,b,n,f,c,h){var g,e,l=[],m=n.type;if(!d._callbacks[a])return[];"keyup"==m&&u(a)&&(b=[a]);for(g=0;g<d._callbacks[a].length;++g)if(e=d._callbacks[a][g],(f||!e.seq||q[e.seq]==e.level)&&m==e.action){var k;(k="keypress"==m&&!n.metaKey&&!n.ctrlKey)||(k=e.modifiers,k=b.sort().join(",")===k.sort().join(","));k&&(k=f&&e.seq==f&&e.level==h,(!f&&e.combo==c||k)&&d._callbacks[a].splice(g,1),l.push(e))}return l}function g(a,b,n,f){d.stopCallback(b,
			b.target||b.srcElement,n,f)||!1!==a(b,n)||(b.preventDefault?b.preventDefault():b.returnValue=!1,b.stopPropagation?b.stopPropagation():b.cancelBubble=!0)}function e(a){"number"!==typeof a.which&&(a.which=a.keyCode);var b=x(a);b&&("keyup"==a.type&&w===b?w=!1:d.handleKey(b,D(a),a))}function l(a,c,n,f){function e(c){return function(){v=c;++q[a];clearTimeout(k);k=setTimeout(b,1E3)}}function h(c){g(n,c,a);"keyup"!==f&&(w=x(c));setTimeout(b,10)}for(var d=q[a]=0;d<c.length;++d){var p=d+1===c.length?h:e(f||
			y(c[d+1]).action);m(c[d],p,f,a,d)}}function m(a,b,c,f,e){d._directMap[a+":"+c]=b;a=a.replace(/\s+/g," ");var g=a.split(" ");1<g.length?l(a,g,b,c):(c=y(a,c),d._callbacks[c.key]=d._callbacks[c.key]||[],h(c.key,c.modifiers,{type:c.action},f,a,e),d._callbacks[c.key][f?"unshift":"push"]({callback:b,modifiers:c.modifiers,action:c.action,seq:f,level:e,combo:a}))}var d=this;a=a||r;if(!(d instanceof c))return new c(a);d.target=a;d._callbacks={};d._directMap={};var q={},k,w=!1,p=!1,v=!1;d._handleKey=function(a,
			c,e){var f=h(a,c,e),d;c={};var k=0,l=!1;for(d=0;d<f.length;++d)f[d].seq&&(k=Math.max(k,f[d].level));for(d=0;d<f.length;++d)f[d].seq?f[d].level==k&&(l=!0,c[f[d].seq]=1,g(f[d].callback,e,f[d].combo,f[d].seq)):l||g(f[d].callback,e,f[d].combo);f="keypress"==e.type&&p;e.type!=v||u(a)||f||b(c);p=l&&"keydown"==e.type};d._bindMultiple=function(a,b,c){for(var d=0;d<a.length;++d)m(a[d],b,c)};t(a,"keypress",e);t(a,"keydown",e);t(a,"keyup",e)}var l={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",
			20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},p={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},A={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},z={option:"alt",command:"meta","return":"enter",
			escape:"esc",plus:"+",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},k;for(g=1;20>g;++g)l[111+g]="f"+g;for(g=0;9>=g;++g)l[g+96]=g;c.prototype.bind=function(a,b,c){a=a instanceof Array?a:[a];this._bindMultiple.call(this,a,b,c);return this};c.prototype.unbind=function(a,b){return this.bind.call(this,a,function(){},b)};c.prototype.trigger=function(a,b){if(this._directMap[a+":"+b])this._directMap[a+":"+b]({},a);return this};c.prototype.reset=function(){this._callbacks={};this._directMap=
			{};return this};c.prototype.stopCallback=function(a,b){return-1<(" "+b.className+" ").indexOf(" mousetrap ")||B(b,this.target)?!1:"INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable};c.prototype.handleKey=function(){return this._handleKey.apply(this,arguments)};c.init=function(){var a=c(r),b;for(b in a)"_"!==b.charAt(0)&&(c[b]=function(b){return function(){return a[b].apply(a,arguments)}}(b))};c.init();C.Mousetrap=c;"undefined"!==typeof module&&module.exports&&(module.exports=
			c);"function"===typeof define&&define.amd&&define(function(){return c})})(window,document);
		</script>

	</head>

	<body style="height:100%; width: 100vw; background-color:#98dde6; ">
		<br>
		<div class="row" style="height:100%; width: 100vw; padding-right: 30px; margin: 30px;" >
			<textarea id="get" name="get" rows="20" cols="80" style="margin: 3px;" class="mousetrap">This is a collaborative text editor</textarea>
		</div>

		<div>
			<h3> Connected Users  And Positions</h3>
			<div id="connected_user" >
				<ul id="connected_user_list"></ul>
			</div>
		</div>
<!-- 		 <br>
		<div>
			<h3> Current Position of Users </h3>
			<ul id="current_position" >
			</ul>
		</div>
		<br> -->

	<script>
		var socket = io();
		var previousCaretPos = 0;
		var CaretPos = 0;
		var ctrl = document.getElementById('get');
		var keynum = 0;

		document.addEventListener("keypress", checkInput);  //or however you are calling your method

		Mousetrap.bind('backspace', function(e) {
			checkInput(e);
			sendInfoToServer(dict);
		});

		function checkInput(e) {
			var state;
			if(window.addEventListener) { // IE
				keynum = e.keyCode;
			} else if (e.which) { // Netscape/Firefox/Opera
				keynum = e.which;
			}
			var whichKeyPressed = String.fromCharCode(keynum);

			// IE Support
			if (document.selection) {
				var Sel = document.selection.createRange ();
				ctrl.focus ();
				Sel.moveStart ('character', -ctrl.value.length);
				previousCaretPos = CaretPos;
				CaretPos = Sel.text.length;
			}

			// Firefox support
			if (ctrl.selectionStart || ctrl.selectionStart == '0') {
				previousCaretPos = CaretPos;
				CaretPos = ctrl.selectionStart;
			}
			// console.log("ctrl value :  " + ctrl.value + whichKeyPressed);
			dict = {
				'caretPos' : CaretPos + 1,
				'text' : ctrl.value + whichKeyPressed,
				'previousCaretPos' : previousCaretPos + 1,
			}

			if (dict.caretPos !== previousCaretPos) {
				sendInfoToServer(dict);
			}
		}

		function sendInfoToServer(dict) {
			console.log(dict['text']);
			socket.emit('text editor', dict);
		}

		function setCaretPosition(pos, keyToInsert){
			if(ctrl.setSelectionRange) {
				ctrl.focus();
				ctrl.setSelectionRange(pos,pos);
				console.log(keyToInsert);
				insertTextAtCaret(ctrl, keyToInsert);
			} else if (ctrl.createTextRange) {
				ctrl.focus();
				var range = ctrl.createTextRange();
				range.collapse(true);
				range.moveEnd('character', pos);
				range.moveStart('character', pos);
				insertTextAtCaret(ctrl, keyToInsert);
				console.log(keyToInsert);
				range.select();
			}
		}

		function insertTextAtCaret(el, text) {
			var pos = getInputSelection(el).end;
			var newPos = pos + text.length;
			var val = el.value;

			if (text === "") {
				el.value = val.slice(0, pos - 1) + val.slice(pos);
				setSelection(el, newPos, newPos);
			}

			el.value = val.slice(0, pos) + text + val.slice(pos);
			setSelection(el, newPos, newPos);
		}

// 		function deleteTextAtCaret(el) {
// 			console.log("deleteing...");
// 			var pos = getInputSelection(el).end;
// 			var newPos = pos + 1;
// 			var val = el.value;
// 			el.value = val.slice(0, pos - 2) + val.slice(pos);
// 			setSelection(el, newPos, newPos);
// 			console.log("deleted..");
// 		}

// 		function getInputSelection(el) {
// 			var start = 0, end = 0, normalizedValue, range,
// 			textInputRange, len, endRange;

// 			if (typeof el.selectionStart == "number" && typeof el.selectionEnd == "number") {
// 				start = el.selectionStart;
// 				end = el.selectionEnd;
// 			} else {
// 				range = document.selection.createRange();

// 				if (range && range.parentElement() == el) {
// 					len = el.value.length;
// 					normalizedValue = el.value.replace(/\r\n/g, "\n");

// 			// Create a working TextRange that lives only in the input
// 			textInputRange = el.createTextRange();
// 			textInputRange.moveToBookmark(range.getBookmark());

// 			// Check if the start and end of the selection are at the very end
// 			// of the input, since moveStart/moveEnd doesn't return what we want
// 			// in those cases
// 			endRange = el.createTextRange();
// 			endRange.collapse(false);

// 			if (textInputRange.compareEndPoints("StartToEnd", endRange) > -1) {
// 				start = end = len;
// 			} else {
// 				start = -textInputRange.moveStart("character", -len);
// 				start += normalizedValue.slice(0, start).split("\n").length - 1;

// 				if (textInputRange.compareEndPoints("EndToEnd", endRange) > -1) {
// 					end = len;
// 				} else {
// 					end = -textInputRange.moveEnd("character", -len);
// 					end += normalizedValue.slice(0, end).split("\n").length - 1;
// 				}
// 			}
// 		}
// 	}

// 	return {
// 		start: start,
// 		end: end
// 	};
// }

// function offsetToRangeCharacterMove(el, offset) {
// 	return offset - (el.value.slice(0, offset).split("\r\n").length - 1);
// }

// function setSelection(el, start, end) {
// 	if (typeof el.selectionStart == "number" && typeof el.selectionEnd == "number") {
// 		el.selectionStart = start;
// 		el.selectionEnd = end;
// 	} else if (typeof el.createTextRange != "undefined") {
// 		var range = el.createTextRange();
// 		var startCharMove = offsetToRangeCharacterMove(el, start);
// 		range.collapse(true);
// 		if (start == end) {
// 			range.move("character", startCharMove);
// 		} else {
// 			range.moveEnd("character", offsetToRangeCharacterMove(el, end));
// 			range.moveStart("character", startCharMove);
// 		}
// 		range.select();
// 	}
// }

function addCursorPos(str){
	var div = document.getElementById("connected-user");
	var ul = document.getElementById("connected-user-list");
	div.removeChild(ul);

}
socket.on('text editor', function(msg) {
		// console.log(msg);
		$('#current_position').replaceWith($('<div>').text(JSON.stringify(msg['id'] + "   "+msg['caretPos'])));
		$('#connected_user_list').replaceWith($('<ul id ="connected_user_list">').text(msg["connected-user"]));
		console.log(msg["connected-user"])
		ctrl.value = msg.text;
		// console.log("info recived from other user :  " + msg.text)
		// console.log("other user :  " + msg["connected-user"])
		setCaretPosition(msg.caretPos, msg.text); 
	});

socket.on('connected_user',function (msg){
	console.log(msg["connected-user"])
	var textarea = document.getElementById("get");
	textarea.innerHTML = msg.text;
	$('#connected_user_list').replaceWith($('<ul id ="connected_user_list">').text(msg["connected-user"]));

});

window.onload = function (){
	dict ={};
	socket.emit('connected_user', dict)
}
	</script>
  </body>
</html>
